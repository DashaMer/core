- hosts: ~.*slave.*
  user: "{{ user }}"
  gather_facts: true
  tasks:
  - group_by: key=slaves

- hosts: ~.*master.*
  user: "{{ user }}"
  gather_facts: true
  tasks:
  - group_by: key=masters

- hosts: slaves
  user: "{{ user }}"
  sudo: yes
  vars:
    public_dns : ["8.8.8.8", "8.8.4.4"]
    masters_str: |
        {% set comma = joiner(",") %}
        {% set eth = "ansible_"+local_iface %}
        {% for item in groups["masters"] -%}
            {{ comma() }}{{ hostvars[item][eth].ipv4.address }}
        {%- endfor %}
  pre_tasks:
    - set_fact:
        masters : "{{ masters_str|trim|split(',') }}" 
    - set_fact:
        my_zk_hostnames: "{{masters|join(':2181,')}}:2181"
    - set_fact:
        a_local_iface: "ansible_{{ local_iface }}"
    - set_fact:
        local_ip: "{{ hostvars[inventory_hostname][a_local_iface].ipv4.address }}"
  roles:
    - role: ansible-swap
      swap_file_size: "{{ ansible_memtotal_mb }}M"

    - role: ansible-consul
      dns_nameservers: "{{ public_dns }}"
      dns_domain: "node.consul"
      consul_servers: "{{ masters }}"
      install_bind: false
      dns_nameservers: "{{ masters }}"
      consul_is_server: false
      consul_domain: "consul."
      consul_client_address: "{{ local_ip }}"
      consul_bind_address: "{{ consul_client_address }}"

    - role: ansible-mesos
      mesos_ip: "{{ local_ip }}"
      mesos_hostname: "{{ ansible_hostname }}"
      mesos_containerizers: "docker,mesos"
      zookeeper_hostnames: "{{ my_zk_hostnames }}"
      mesos_resources: "mem(*):{{ ansible_memtotal_mb }}"
      mesos_install_mode: "slave"
      mesos_version: 0.24.0

    - role: ansible-docker
      docker_opts: '"--insecure-registry docker-registry.service.consul:5000"' 

    - role: ansible-scala

    - role: ansible-spark
      spark_version: "1.5.2-bin-hadoop2.6"
      spark_mirror: "http://mirror.cogentco.com/pub/apache/spark/spark-1.5.2"

    - role: ansible-beats

  post_tasks:
    - lineinfile: dest=/etc/environment line="SPARK_HOME={{ spark_usr_dir }}"
    - lineinfile: dest=/etc/environment line="SCALA_HOME={{ scala_lib_path_target }}"
    - lineinfile: dest=/etc/environment line="JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64"
